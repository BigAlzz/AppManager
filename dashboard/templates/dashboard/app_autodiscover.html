{% extends 'dashboard/base.html' %}

{% block title %}Autodiscover Apps{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">Autodiscover Applications</h3>
            </div>
            <div class="card-body">
                {% if success %}
                <div class="alert alert-success">
                    <h4 class="alert-heading">Discovery Complete!</h4>
                    <p>Applications have been successfully added to your dashboard.</p>
                    <hr>
                    <a href="{% url 'app_list' %}" class="btn btn-success">
                        <i class="fas fa-list"></i> View Applications
                    </a>
                </div>
                {% endif %}

                {% if error %}
                <div class="alert alert-danger">
                    <h4 class="alert-heading">Error During Discovery</h4>
                    <p>{{ error }}</p>
                </div>
                {% endif %}

                {% if logs %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Discovery Log</h5>
                    </div>
                    <div class="card-body">
                        <pre class="discovery-log">{% for log in logs %}{{ log }}
{% endfor %}</pre>
                    </div>
                </div>
                {% endif %}

                <p class="lead">
                    Point to a directory containing your applications, and we'll automatically discover and add them.
                </p>
                <p>The autodiscovery process will:</p>
                <ul>
                    <li>Look for main entry points (manage.py, main.py)</li>
                    <li>Detect other Python files with main functions</li>
                    <li>Find executables and scripts</li>
                    <li>Extract documentation and user guides</li>
                </ul>
                
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="directory" class="form-label">Directory Path</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="directory" name="directory" required>
                            <button type="button" class="btn btn-outline-secondary" id="browse-button">
                                <i class="fas fa-folder-open"></i> Browse
                            </button>
                        </div>
                        <div class="form-text">Select the root directory containing your applications</div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Discover Applications
                        </button>
                        <a href="{% url 'app_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- File Explorer Modal -->
<div class="modal fade" id="fileExplorerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Directory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb" id="path-breadcrumb">
                        <li class="breadcrumb-item"><a href="#" data-path="">Computer</a></li>
                    </ol>
                </nav>
                <div class="list-group" id="file-list">
                    <!-- Items will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="select-path" data-bs-dismiss="modal">Select Directory</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<style>
.discovery-log {
    background-color: #f8f9fa;
    padding: 1rem;
    font-family: monospace;
    font-size: 0.9rem;
    white-space: pre-wrap;
    max-height: 400px;
    overflow-y: auto;
}
</style>
<script>
let currentPath = '';
const modal = new bootstrap.Modal(document.getElementById('fileExplorerModal'));

document.getElementById('browse-button').addEventListener('click', function() {
    loadDirectory('');
    modal.show();
});

function loadDirectory(path) {
    currentPath = path;
    fetch(`/list-directory/?path=${encodeURIComponent(path)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            // Update breadcrumb
            const breadcrumb = document.getElementById('path-breadcrumb');
            breadcrumb.innerHTML = '';
            
            // Add computer (root) link
            const computerItem = document.createElement('li');
            computerItem.className = 'breadcrumb-item';
            const computerLink = document.createElement('a');
            computerLink.href = '#';
            computerLink.textContent = 'Computer';
            computerLink.addEventListener('click', (e) => {
                e.preventDefault();
                loadDirectory('');
            });
            computerItem.appendChild(computerLink);
            breadcrumb.appendChild(computerItem);
            
            // Add path segments
            if (data.current_path) {
                const segments = data.current_path.split(/[\\/]/);
                let currentSegmentPath = '';
                
                segments.forEach((segment, index) => {
                    if (!segment) return;
                    
                    currentSegmentPath += (currentSegmentPath ? '\\' : '') + segment;
                    const item = document.createElement('li');
                    item.className = 'breadcrumb-item';
                    
                    if (index === segments.length - 1) {
                        item.classList.add('active');
                        item.textContent = segment;
                    } else {
                        const link = document.createElement('a');
                        link.href = '#';
                        link.textContent = segment;
                        const pathCopy = currentSegmentPath;
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            loadDirectory(pathCopy);
                        });
                        item.appendChild(link);
                    }
                    
                    breadcrumb.appendChild(item);
                });
            }
            
            // Update file list
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            
            // Add parent directory if available and not at root
            if (data.parent_path && !data.is_root) {
                const parentItem = document.createElement('a');
                parentItem.href = '#';
                parentItem.className = 'list-group-item list-group-item-action';
                parentItem.innerHTML = '<i class="fas fa-level-up-alt me-2"></i> ..';
                parentItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadDirectory(data.parent_path);
                });
                fileList.appendChild(parentItem);
            }
            
            // Add items (show only directories)
            data.items.forEach(item => {
                if (item.type === 'directory') {
                    const listItem = document.createElement('a');
                    listItem.href = '#';
                    listItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    
                    const leftContent = document.createElement('div');
                    leftContent.innerHTML = `<i class="fas fa-folder me-2"></i> ${item.name}`;
                    
                    const rightContent = document.createElement('small');
                    rightContent.className = 'text-muted';
                    rightContent.textContent = item.details || '';
                    
                    listItem.appendChild(leftContent);
                    listItem.appendChild(rightContent);
                    
                    listItem.addEventListener('click', (e) => {
                        e.preventDefault();
                        loadDirectory(item.path);
                    });
                    
                    fileList.appendChild(listItem);
                }
            });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading directory');
        });
}

document.getElementById('select-path').addEventListener('click', function() {
    document.getElementById('directory').value = currentPath;
});
</script>
{% endblock %} 