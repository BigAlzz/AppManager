{% extends 'dashboard/base.html' %}

{% block title %}{{ action }} App{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">{{ action }} Application</h3>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" name="name" required
                               value="{{ app.name|default:'' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="path" class="form-label">Path</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="path" name="path" required
                                   value="{{ app.path|default:'' }}">
                            <button type="button" class="btn btn-outline-secondary" id="browse-button">
                                <i class="fas fa-folder-open"></i> Browse
                            </button>
                        </div>
                        <div class="form-text">Full path to the executable, script, or URL</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="type" class="form-label">Type</label>
                        <select class="form-select" id="type" name="type" required>
                            <option value="">Select type...</option>
                            <option value="executable" {% if app.type == 'executable' %}selected{% endif %}>Executable</option>
                            <option value="script" {% if app.type == 'script' %}selected{% endif %}>Script</option>
                            <option value="web" {% if app.type == 'web' %}selected{% endif %}>Web Tool</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ app.description|default:'' }}</textarea>
                        <div class="form-text">Brief description of the application</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="user_guide" class="form-label">User Guide</label>
                        <textarea class="form-control" id="user_guide" name="user_guide" rows="10">{{ app.user_guide|default:'' }}</textarea>
                        <div class="form-text">Detailed instructions on how to use this application</div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Application
                        </button>
                        <a href="{% url 'app_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- File Explorer Modal -->
<div class="modal fade" id="fileExplorerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">File Explorer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb" id="path-breadcrumb">
                        <li class="breadcrumb-item"><a href="#" data-path="">Computer</a></li>
                    </ol>
                </nav>
                <div class="list-group" id="file-list">
                    <!-- Items will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="select-path" data-bs-dismiss="modal">Select</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPath = '';
const modal = new bootstrap.Modal(document.getElementById('fileExplorerModal'));

document.getElementById('browse-button').addEventListener('click', function() {
    loadDirectory('');
    modal.show();
});

function loadDirectory(path) {
    currentPath = path;
    fetch(`/list-directory/?path=${encodeURIComponent(path)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            // Update breadcrumb
            const breadcrumb = document.getElementById('path-breadcrumb');
            breadcrumb.innerHTML = '';
            
            // Add computer (root) link
            const computerItem = document.createElement('li');
            computerItem.className = 'breadcrumb-item';
            const computerLink = document.createElement('a');
            computerLink.href = '#';
            computerLink.textContent = 'Computer';
            computerLink.addEventListener('click', (e) => {
                e.preventDefault();
                loadDirectory('');
            });
            computerItem.appendChild(computerLink);
            breadcrumb.appendChild(computerItem);
            
            // Add path segments
            if (data.current_path) {
                const segments = data.current_path.split(/[\\/]/);
                let currentSegmentPath = '';
                
                segments.forEach((segment, index) => {
                    if (!segment) return;
                    
                    currentSegmentPath += (currentSegmentPath ? '\\' : '') + segment;
                    const item = document.createElement('li');
                    item.className = 'breadcrumb-item';
                    
                    if (index === segments.length - 1) {
                        item.classList.add('active');
                        item.textContent = segment;
                    } else {
                        const link = document.createElement('a');
                        link.href = '#';
                        link.textContent = segment;
                        const pathCopy = currentSegmentPath;
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            loadDirectory(pathCopy);
                        });
                        item.appendChild(link);
                    }
                    
                    breadcrumb.appendChild(item);
                });
            }
            
            // Update file list
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            
            // Add parent directory if available and not at root
            if (data.parent_path && !data.is_root) {
                const parentItem = document.createElement('a');
                parentItem.href = '#';
                parentItem.className = 'list-group-item list-group-item-action';
                parentItem.innerHTML = '<i class="fas fa-level-up-alt me-2"></i> ..';
                parentItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadDirectory(data.parent_path);
                });
                fileList.appendChild(parentItem);
            }
            
            // Add items
            data.items.forEach(item => {
                const listItem = document.createElement('a');
                listItem.href = '#';
                listItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                
                const icon = item.type === 'directory' ? 'fa-folder' : 'fa-file';
                const leftContent = document.createElement('div');
                leftContent.innerHTML = `<i class="fas ${icon} me-2"></i> ${item.name}`;
                
                const rightContent = document.createElement('small');
                rightContent.className = 'text-muted';
                rightContent.textContent = item.details || '';
                
                listItem.appendChild(leftContent);
                listItem.appendChild(rightContent);
                
                listItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (item.type === 'directory') {
                        loadDirectory(item.path);
                    } else {
                        document.getElementById('path').value = item.path;
                        modal.hide();
                    }
                });
                
                // Add double-click handler for files
                if (item.type !== 'directory') {
                    listItem.addEventListener('dblclick', (e) => {
                        e.preventDefault();
                        document.getElementById('path').value = item.path;
                        modal.hide();
                    });
                }
                
                fileList.appendChild(listItem);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading directory');
        });
}

document.getElementById('select-path').addEventListener('click', function() {
    document.getElementById('path').value = currentPath;
});
</script>
{% endblock %} 