{% extends 'dashboard/base.html' %}

{% block title %}Apps{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-auto">
        <h2>Applications</h2>
    </div>
    <div class="col-auto">
        <select id="sortApps" class="form-select">
            <option value="name">Sort by Name</option>
            <option value="running">Running First</option>
            <option value="rating-desc">Highest Rated</option>
            <option value="rating-asc">Lowest Rated</option>
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
        </select>
    </div>
    <div class="col-auto">
        <input type="text" id="appFilter" class="form-control" placeholder="Quick filter..." style="width: 150px;">
    </div>
    <div class="col text-end">
        <div class="d-inline-flex align-items-center">
            <form method="post" action="{% url 'cleanup_autodiscovered' %}" class="me-2">
                {% csrf_token %}
                <div class="input-group">
                    <select name="minutes" class="form-select" style="width: auto;">
                        <option value="5">Last 5 minutes</option>
                        <option value="15">Last 15 minutes</option>
                        <option value="30">Last 30 minutes</option>
                        <option value="60">Last hour</option>
                        <option value="1440">Last 24 hours</option>
                        <option value="10080">Last week</option>
                    </select>
                    <button type="submit" class="btn btn-warning" onclick="return confirm('This will remove all applications added in the selected time range. Continue?')">
                        <i class="fas fa-broom"></i> Clean Recent Apps
                    </button>
                </div>
            </form>
            <a href="{% url 'app_autodiscover' %}" class="btn btn-info me-2">
                <i class="fas fa-search"></i> Autodiscover Apps
            </a>
            <a href="{% url 'app_add' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Application
            </a>
        </div>
    </div>
</div>

<div class="row row-cols-1 row-cols-md-3 g-4">
    {% for app in apps %}
    <div class="col">
        <div class="card h-100 app-card">
            <div class="card-body position-relative">
                <span class="badge {% if app.status == 'Running' %}bg-success{% else %}bg-secondary{% endif %} status-badge">
                    {{ app.status }}{% if app.status == 'Running' and app.port %} (Port: {{ app.port }}){% endif %}
                </span>
                <div class="star-rating mb-2" data-app-id="{{ app.id }}">
                    {% for i in "12345" %}
                    <i class="fas fa-star star-icon {% if app.rating >= forloop.counter %}text-warning{% else %}text-muted{% endif %}" 
                       data-rating="{{ forloop.counter }}" 
                       style="cursor: pointer;"></i>
                    {% endfor %}
                </div>
                <h5 class="card-title">{{ app.name }}</h5>
                <h6 class="card-subtitle mb-2 text-muted">{{ app.type }}</h6>
                <p class="card-text description-truncate">{{ app.description|default:"No description"|truncatechars:100 }}</p>
                <p class="card-text">
                    <small class="text-muted">Path: {{ app.path }}</small>
                </p>
                <p class="card-text">
                    <small class="text-muted created-at">{{ app.created_at|date:"c" }}</small>
                </p>
                {% if app.user_guide %}
                <button class="btn btn-link btn-sm p-0" onclick="showUserGuide('{{ app.name|escapejs }}', '{{ app.user_guide|escapejs }}')">
                    <i class="fas fa-book"></i> View User Guide
                </button>
                {% endif %}
            </div>
            <div class="card-footer bg-transparent">
                <div class="btn-group w-100">
                    {% if app.status == 'Running' %}
                    <button class="btn btn-danger btn-sm app-action" data-action="stop" data-app-id="{{ app.id }}">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    {% else %}
                    <button class="btn btn-success btn-sm app-action" data-action="launch" data-app-id="{{ app.id }}">
                        <i class="fas fa-play"></i> Launch
                    </button>
                    {% endif %}
                    <a href="{% url 'app_edit' app.id %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <a href="{% url 'app_delete' app.id %}" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i> Delete
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-info">
            No applications found. <a href="{% url 'app_add' %}">Add your first application</a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- User Guide Modal -->
<div class="modal fade" id="userGuideModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Guide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h4 id="userGuideTitle" class="mb-3"></h4>
                <div id="userGuideContent" class="user-guide-content"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Terminal Output Modal -->
<div class="modal fade" id="terminalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Terminal Output</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="terminalOutputStandalone" class="terminal-output"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="loadingModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loadingModalLabel">Loading Application: <span id="loadingAppName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="installDepsToggle">
                    <label class="form-check-label" for="installDepsToggle">
                        Install Dependencies
                    </label>
                </div>
                <div class="d-flex justify-content-center mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="loadingTerminalOutput" class="terminal-window">
                    <pre id="terminalText" class="terminal-text"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.description-truncate {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    min-height: 4.5em;
}
.user-guide-content {
    white-space: pre-wrap;
    max-height: 60vh;
    overflow-y: auto;
}
.terminal-output {
    background-color: #1e1e1e;
    color: #ffffff;
    font-family: 'Consolas', 'Monaco', monospace;
    padding: 1rem;
    border-radius: 4px;
    white-space: pre-wrap;
    max-height: 60vh;
    overflow-y: auto;
}
.terminal-output .error {
    color: #ff6b6b;
}

#loadingModal .modal-content {
    border: none;
    border-radius: 8px;
}

#loadingModal .modal-header {
    border-radius: 8px 8px 0 0;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

.star-icon {
    font-size: 1.2rem;
    margin-right: 2px;
    transition: color 0.2s ease-in-out;
}

.star-icon:hover {
    transform: scale(1.1);
}

.star-rating {
    display: inline-block;
}

.app-card {
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.app-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
}

.terminal-window {
    background-color: #1e1e1e;
    border: 1px solid #333;
    border-radius: 4px;
    padding: 10px;
    margin-top: 10px;
    min-height: 200px;
    max-height: 400px;
    overflow-y: auto;
}

.terminal-text {
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 14px;
    color: #fff;
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.terminal-text .error {
    color: #ff6b6b;
}

.terminal-text .success {
    color: #69db7c;
}

.terminal-text .warning {
    color: #ffd43b;
}

.terminal-text .info {
    color: #4dabf7;
}
</style>

<script>
const userGuideModal = new bootstrap.Modal(document.getElementById('userGuideModal'));
const terminalModal = new bootstrap.Modal(document.getElementById('terminalModal'));
const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

// Initialize the appWindows Map to track browser windows
const appWindows = new Map();

// Add event handler for sort dropdown
$('#sortApps').change(function() {
    const sortBy = $(this).val();
    // Save sort preference to localStorage
    localStorage.setItem('appManagerSortPreference', sortBy);
    sortCards(sortBy);
});

function sortCards(sortBy) {
    const container = $('.row.row-cols-1.row-cols-md-3.g-4');
    const cards = container.children('.col').get();
    
    cards.sort(function(a, b) {
        const cardA = $(a).find('.card');
        const cardB = $(b).find('.card');
        
        // Helper function to get name for consistent sorting
        const getName = (card) => card.find('.card-title').text().toLowerCase();
        
        switch(sortBy) {
            case 'running':
                const statusA = cardA.find('.status-badge').text().includes('Running') ? 1 : 0;
                const statusB = cardB.find('.status-badge').text().includes('Running') ? 1 : 0;
                if (statusA !== statusB) {
                    return statusB - statusA;  // Running apps first
                }
                // If status is the same, sort by name
                return getName(cardA).localeCompare(getName(cardB));
                
            case 'name':
                return getName(cardA).localeCompare(getName(cardB));
                
            case 'rating-desc':
                const ratingA = cardA.find('.text-warning').length;
                const ratingB = cardB.find('.text-warning').length;
                return ratingB - ratingA;
                
            case 'rating-asc':
                const ratingAsc1 = cardA.find('.text-warning').length;
                const ratingAsc2 = cardB.find('.text-warning').length;
                return ratingAsc1 - ratingAsc2;
                
            case 'newest':
                const timeA = new Date($(a).find('.created-at').text()).getTime();
                const timeB = new Date($(b).find('.created-at').text()).getTime();
                return timeB - timeA;
                
            case 'oldest':
                const timeOldA = new Date($(a).find('.created-at').text()).getTime();
                const timeOldB = new Date($(b).find('.created-at').text()).getTime();
                return timeOldA - timeOldB;
                
            default:
                return 0;
        }
    });
    
    // Reattach sorted cards to container
    cards.forEach(function(card) {
        container.append(card);
    });
}

// Initialize sorting on page load
$(document).ready(function() {
    // Get saved sort preference from localStorage
    const savedSort = localStorage.getItem('appManagerSortPreference') || 'name';
    // Set the dropdown to the saved value
    $('#sortApps').val(savedSort);
    // Apply the sorting
    sortCards(savedSort);
    
    // Rest of your existing document.ready code...
});

function showUserGuide(appName, userGuide) {
    document.getElementById('userGuideTitle').textContent = appName;
    document.getElementById('userGuideContent').textContent = userGuide;
    userGuideModal.show();
}

function showTerminalOutput(output, title = 'Terminal Output') {
    const terminalDiv = document.getElementById('terminalOutputStandalone');
    terminalDiv.innerHTML = '';
    
    if (output) {
        const lines = output.split('\n');
        lines.forEach(line => {
            const div = document.createElement('div');
            if (line.startsWith('ERROR:')) {
                div.className = 'error';
            }
            div.textContent = line;
            terminalDiv.appendChild(div);
        });
    } else {
        terminalDiv.textContent = 'No output available yet...';
    }
    
    document.querySelector('#terminalModal .modal-title').textContent = title;
    terminalModal.show();
}

function updateAppStatus(appId) {
    appId = parseInt(appId); // Ensure appId is parsed as integer
    $.ajax({
        url: `/api/apps/${appId}/check_status/`,
        method: 'GET',
        success: function(response) {
            const card = $(`.app-card[data-app-id="${appId}"]`);
            const statusBadge = card.find('.status-badge');
            const actionButton = card.find('.app-action');
            
            // Update status badge
            statusBadge.text(response.status + (response.port ? ` (Port: ${response.port})` : ''));
            statusBadge.removeClass('bg-success bg-secondary')
                .addClass(response.status === 'Running' ? 'bg-success' : 'bg-secondary');
            
            // Update action button
            if (response.status === 'Running') {
                actionButton
                    .removeClass('btn-success')
                    .addClass('btn-danger')
                    .html('<i class="fas fa-stop"></i> Stop')
                    .data('action', 'stop');
            } else {
                actionButton
                    .removeClass('btn-danger')
                    .addClass('btn-success')
                    .html('<i class="fas fa-play"></i> Launch')
                    .data('action', 'launch');
                
                // If status changed to stopped, close browser window
                const appWindow = appWindows.get(appId);
                if (appWindow && !appWindow.closed) {
                    try {
                        appWindow.close();
                    } catch (e) {
                        console.log('Failed to close window in status check:', e);
                    }
                }
                appWindows.delete(appId);
            }
        }
    });
}

// Set up periodic status checks for all apps
function setupStatusChecks() {
    const appCards = document.querySelectorAll('.app-card');
    appCards.forEach(card => {
        const appId = card.getAttribute('data-app-id');
        if (appId) {
            // Initial check
            updateAppStatus(appId);
            // Set up periodic check every 5 seconds
            setInterval(() => updateAppStatus(appId), 5000);
        }
    });
}

$(document).ready(function() {
    // Add app-id to all cards for status updates
    $('.app-card').each(function() {
        const appId = $(this).find('.app-action').data('app-id');
        $(this).attr('data-app-id', appId);
    });

    // Set up star rating functionality
    $('.star-rating .star-icon').hover(
        function() {
            // Hover in
            const rating = $(this).data('rating');
            const stars = $(this).parent().find('.star-icon');
            stars.removeClass('text-warning').addClass('text-muted');
            stars.slice(0, rating).removeClass('text-muted').addClass('text-warning');
        },
        function() {
            // Hover out - restore original rating
            const container = $(this).parent();
            const appId = container.data('app-id');
            const currentRating = parseInt($(`#current-rating-${appId}`).val()) || 0;
            const stars = container.find('.star-icon');
            stars.removeClass('text-warning').addClass('text-muted');
            stars.slice(0, currentRating).removeClass('text-muted').addClass('text-warning');
        }
    );

    // Handle star click
    $('.star-rating .star-icon').click(function() {
        const rating = $(this).data('rating');
        const container = $(this).parent();
        const appId = container.data('app-id');
        const stars = container.find('.star-icon');

        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Send rating to server
        $.ajax({
            url: `/api/apps/${appId}/`,
            method: 'PATCH',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({ rating: rating }),
            success: function(response) {
                // Update stars
                stars.removeClass('text-warning').addClass('text-muted');
                stars.slice(0, rating).removeClass('text-muted').addClass('text-warning');
                // Store current rating
                if (!$(`#current-rating-${appId}`).length) {
                    container.append(`<input type="hidden" id="current-rating-${appId}" value="${rating}">`);
                } else {
                    $(`#current-rating-${appId}`).val(rating);
                }
            },
            error: function(xhr, status, error) {
                console.error('Failed to update rating:', error);
                // Restore previous rating
                const currentRating = parseInt($(`#current-rating-${appId}`).val()) || 0;
                stars.removeClass('text-warning').addClass('text-muted');
                stars.slice(0, currentRating).removeClass('text-muted').addClass('text-warning');
            }
        });
    });

    // Initialize current ratings
    $('.star-rating').each(function() {
        const container = $(this);
        const appId = container.data('app-id');
        const currentRating = container.find('.text-warning').length;
        container.append(`<input type="hidden" id="current-rating-${appId}" value="${currentRating}">`);
    });

    // Set up status checks
    setupStatusChecks();

    $('.app-action').click(function() {
        const button = $(this);
        const action = button.data('action');
        const appId = parseInt(button.data('app-id'));
        
        if (action === 'launch') {
            const appName = $(this).closest('.card').find('.card-title').text();
            launchApp(appId, appName);
        } else if (action === 'stop') {
            // Disable the button while stopping
            button.prop('disabled', true);
            
            // Show stopping status
            const statusBadge = button.closest('.card').find('.status-badge');
            statusBadge.text('Stopping...');
            
            fetch(`/api/apps/${appId}/stop/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update UI immediately
                    button
                        .removeClass('btn-danger')
                        .addClass('btn-success')
                        .html('<i class="fas fa-play"></i> Launch')
                        .data('action', 'launch')
                        .prop('disabled', false);
                    
                    statusBadge
                        .text('Stopped')
                        .removeClass('bg-success')
                        .addClass('bg-secondary');
                    
                    // Close any associated browser window
                    const appWindow = appWindows.get(appId);
                    if (appWindow && !appWindow.closed) {
                        try {
                            appWindow.close();
                        } catch (e) {
                            console.log('Failed to close window:', e);
                        }
                    }
                    appWindows.delete(appId);
                    
                    // Update status after a brief delay to confirm
                    setTimeout(() => updateAppStatus(appId), 1000);
                } else {
                    // Re-enable button if stop failed
                    button.prop('disabled', false);
                    alert('Failed to stop application: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error stopping app:', error);
                button.prop('disabled', false);
                alert('Error stopping application');
            });
        }
    });

    // Add search filter functionality
    $('#appFilter').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('.app-card').each(function() {
            const appName = $(this).find('.card-title').text().toLowerCase();
            const appPath = $(this).find('.text-muted').text().toLowerCase();
            const matches = appName.includes(searchTerm) || appPath.includes(searchTerm);
            $(this).closest('.col').toggle(matches);
        });
    });
});

function showLoadingScreen(appName) {
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    document.getElementById('loadingAppName').textContent = appName;
    document.getElementById('terminalText').textContent = '';
    loadingModal.show();
}

function hideLoadingScreen() {
    const loadingModal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (loadingModal) {
        loadingModal.hide();
    }
}

function updateTerminalOutput(output) {
    const terminalText = document.getElementById('terminalText');
    if (!terminalText) return;

    // Process the output text to add color coding
    let formattedOutput = output;
    
    // Color code different types of messages
    formattedOutput = formattedOutput.replace(/error|failed|failure/gi, '<span class="error">$&</span>');
    formattedOutput = formattedOutput.replace(/success|activated successfully/gi, '<span class="success">$&</span>');
    formattedOutput = formattedOutput.replace(/warning/gi, '<span class="warning">$&</span>');
    formattedOutput = formattedOutput.replace(/installing|initializing|activating|running/gi, '<span class="info">$&</span>');

    terminalText.innerHTML = formattedOutput;
    terminalText.scrollTop = terminalText.scrollHeight;
}

async function launchApp(appId, appName) {
    showLoadingScreen(appName);
    
    const installDeps = document.getElementById('installDepsToggle').checked;
    updateTerminalOutput('Preparing to launch application...\n' + 
                        (installDeps ? 'Will install dependencies before running\n' : 'Skipping dependency installation\n'));
    
    try {
        const response = await fetch(`/api/apps/${appId}/launch/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                install_dependencies: installDeps
            })
        });

        const data = await response.json();
        
        if (data.success) {
            let isRunning = false;
            let outputPollCount = 0;
            const maxOutputPolls = 30; // Reduced from 60
            
            // Start polling for status and output simultaneously
            const pollInterval = setInterval(async () => {
                try {
                    // Check status
                    if (!isRunning) {
                        const statusResponse = await fetch(`/api/apps/${appId}/check_status/`);
                        const statusData = await statusResponse.json();
                        
                        if (statusData.status === 'Running') {
                            isRunning = true;
                            // Update UI
                            const card = $(`.app-card[data-app-id="${appId}"]`);
                            const actionButton = card.find('.app-action');
                            const statusBadge = card.find('.status-badge');
                            
                            actionButton
                                .removeClass('btn-success')
                                .addClass('btn-danger')
                                .html('<i class="fas fa-stop"></i> Stop')
                                .data('action', 'stop')
                                .prop('disabled', false);
                            
                            statusBadge
                                .text('Running' + (statusData.port ? ` (Port: ${statusData.port})` : ''))
                                .removeClass('bg-secondary')
                                .addClass('bg-success');
                            
                            // If it's a web app, open in browser
                            if (data.url) {
                                window.open(data.url, '_blank');
                                hideLoadingScreen();
                            }
                        }
                    }
                    
                    // Get output
                    const outputResponse = await fetch(`/api/apps/${appId}/output/`);
                    const outputData = await outputResponse.json();
                    
                    if (outputData.output) {
                        updateTerminalOutput(outputData.output);
                    }
                    
                    outputPollCount++;
                    if (outputPollCount >= maxOutputPolls || isRunning) {
                        clearInterval(pollInterval);
                        if (!isRunning) {
                            // If we hit max polls but app isn't running, show error
                            updateTerminalOutput('\nWarning: Application might be taking longer than expected to start.');
                        }
                        setTimeout(hideLoadingScreen, 2000); // Reduced from 10000
                    }
                } catch (error) {
                    console.error('Error polling:', error);
                    clearInterval(pollInterval);
                    setTimeout(hideLoadingScreen, 2000);
                }
            }, 500); // Poll every 500ms instead of 1000ms
        } else {
            updateTerminalOutput(`Error: ${data.error || 'Failed to start application'}`);
            setTimeout(hideLoadingScreen, 2000); // Reduced from 5000
        }
    } catch (error) {
        console.error('Error launching app:', error);
        updateTerminalOutput(`Error: ${error.message}`);
        setTimeout(hideLoadingScreen, 2000);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

let currentPath = '';
</script>
{% endblock %}
