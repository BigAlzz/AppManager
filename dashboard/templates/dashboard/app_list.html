{% extends "dashboard/base.html" %}

{% block title %}Apps{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-auto">
        <h2>Applications</h2>
    </div>
    <div class="col-auto">
        <select id="sortApps" class="form-select">
            <option value="name">Sort by Name</option>
            <option value="running">Running First</option>
            <option value="rating-desc">Highest Rated</option>
            <option value="rating-asc">Lowest Rated</option>
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
        </select>
    </div>
    <div class="col-auto">
        <input type="text" id="appFilter" class="form-control" placeholder="Quick filter..." style="width: 150px;">
    </div>
    <div class="col text-end">
        <div class="d-inline-flex align-items-center">
            <form method="post" action="{% url 'cleanup_autodiscovered' %}" class="me-2">
                {% csrf_token %}
                <div class="input-group">
                    <select name="minutes" class="form-select" style="width: auto;">
                        <option value="5">Last 5 minutes</option>
                        <option value="15">Last 15 minutes</option>
                        <option value="30">Last 30 minutes</option>
                        <option value="60">Last hour</option>
                        <option value="1440">Last 24 hours</option>
                        <option value="10080">Last week</option>
                    </select>
                    <button type="submit" class="btn btn-warning" onclick="return confirm('This will remove all applications added in the selected time range. Continue?')">
                        <i class="fas fa-broom"></i> Clean Recent Apps
                    </button>
                </div>
            </form>
            <a href="{% url 'app_autodiscover' %}" class="btn btn-info me-2">
                <i class="fas fa-search"></i> Autodiscover Apps
            </a>
            <a href="{% url 'app_add' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Application
            </a>
        </div>
    </div>
</div>

<!-- Loading Screen -->
<div id="loadingScreen" class="loading-screen" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-2">Loading</div>
</div>

<!-- Application Cards -->
<div class="row row-cols-1 row-cols-md-3 g-4">
    {% for app in apps %}
    <div class="col">
        <div class="card h-100 app-card">
            <div class="card-body position-relative">
                <span class="badge {% if app.status == 'Running' %}bg-success{% else %}bg-secondary{% endif %} status-badge" data-app-id="{{ app.id }}">
                    {{ app.status }}{% if app.status == 'Running' and app.port %} (Port: {{ app.port }}){% endif %}
                </span>
                <div class="star-rating mb-2" data-app-id="{{ app.id }}">
                    {% for i in "12345" %}
                    <i class="fas fa-star star-icon {% if app.rating >= forloop.counter %}text-warning{% else %}text-muted{% endif %}" 
                       data-rating="{{ forloop.counter }}" 
                       style="cursor: pointer;"></i>
                    {% endfor %}
                </div>
                <h5 class="card-title">{{ app.name }}</h5>
                <h6 class="card-subtitle mb-2 text-muted">{{ app.type }}</h6>
                <p class="card-text description-truncate">{{ app.description|default:"No description"|truncatechars:100 }}</p>
                <p class="card-text">
                    <small class="text-muted">Path: {{ app.path }}</small>
                </p>
                <p class="card-text">
                    <small class="text-muted created-at">{{ app.created_at|date:"c" }}</small>
                </p>
                {% if app.user_guide %}
                <button class="btn btn-link btn-sm p-0" onclick="showUserGuide('{{ app.name|escapejs }}', '{{ app.user_guide|escapejs }}')">
                    <i class="fas fa-book"></i> View User Guide
                </button>
                {% endif %}
            </div>
            <div class="card-footer bg-transparent">
                <div class="btn-group w-100">
                    {% if app.status == 'Running' %}
                    <button class="btn btn-danger btn-sm app-action" data-action="stop" data-app-id="{{ app.id }}" onclick="stopApp({{ app.id }})">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    {% else %}
                    <button class="btn btn-success btn-sm app-action" data-action="launch" data-app-id="{{ app.id }}" onclick="launchApp({{ app.id }})">
                        <i class="fas fa-play"></i> Launch
                    </button>
                    {% endif %}
                    <a href="{% url 'app_edit' app.id %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <a href="{% url 'app_delete' app.id %}" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i> Delete
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-info">
            No applications found. <a href="{% url 'app_add' %}">Add your first application</a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- User Guide Modal -->
<div class="modal fade" id="userGuideModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Guide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h4 id="userGuideTitle" class="mb-3"></h4>
                <div id="userGuideContent" class="user-guide-content"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Terminal Output Modal -->
<div class="modal fade" id="terminalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Terminal Output</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="terminalOutputStandalone" class="terminal-output"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="loadingModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loadingModalLabel">Loading Application: <span id="loadingAppName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="installDepsToggle">
                    <label class="form-check-label" for="installDepsToggle">
                        Install Dependencies
                    </label>
                </div>
                <div class="d-flex justify-content-center mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="loadingTerminalOutput" class="terminal-window">
                    <pre id="terminalText" class="terminal-text"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
(function() {
    'use strict';

    // Add search filter functionality
    $('#appFilter').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('.app-card').each(function() {
            const appName = $(this).find('.card-title').text().toLowerCase();
            const appPath = $(this).find('.text-muted').text().toLowerCase();
            const matches = appName.includes(searchTerm) || appPath.includes(searchTerm);
            $(this).closest('.col').toggle(matches);
        });
    });

    // Add sort functionality
    $('#sortApps').change(function() {
        const sortBy = $(this).val();
        // Save sort preference to localStorage
        localStorage.setItem('appManagerSortPreference', sortBy);
        sortCards(sortBy);
    });

    function sortCards(sortBy) {
        const container = $('.row.row-cols-1.row-cols-md-3.g-4');
        const cards = container.children('.col').get();
        
        cards.sort(function(a, b) {
            const cardA = $(a).find('.card');
            const cardB = $(b).find('.card');
            
            // Helper function to get name for consistent sorting
            const getName = function(card) {
                return card.find('.card-title').text().toLowerCase();
            };
            
            switch(sortBy) {
                case 'running': {
                    const statusA = cardA.find('.status-badge').text().includes('Running') ? 1 : 0;
                    const statusB = cardB.find('.status-badge').text().includes('Running') ? 1 : 0;
                    if (statusA !== statusB) {
                        return statusB - statusA;  // Running apps first
                    }
                    // If status is the same, sort by name
                    return getName(cardA).localeCompare(getName(cardB));
                }
                case 'name':
                    return getName(cardA).localeCompare(getName(cardB));
                case 'rating-desc': {
                    const ratingA = cardA.find('.text-warning').length;
                    const ratingB = cardB.find('.text-warning').length;
                    return ratingB - ratingA;
                }
                case 'rating-asc': {
                    const ratingAsc1 = cardA.find('.text-warning').length;
                    const ratingAsc2 = cardB.find('.text-warning').length;
                    return ratingAsc1 - ratingAsc2;
                }
                case 'newest': {
                    const timeA = new Date($(a).find('.created-at').text()).getTime();
                    const timeB = new Date($(b).find('.created-at').text()).getTime();
                    return timeB - timeA;
                }
                case 'oldest': {
                    const timeOldA = new Date($(a).find('.created-at').text()).getTime();
                    const timeOldB = new Date($(b).find('.created-at').text()).getTime();
                    return timeOldA - timeOldB;
                }
                default:
                    return 0;
            }
        });
        
        // Reattach sorted cards to container
        cards.forEach(function(card) {
            container.append(card);
        });
    }

    // Initialize sorting on page load
    $(document).ready(function() {
        // Get saved sort preference from localStorage
        const savedSort = localStorage.getItem('appManagerSortPreference') || 'name';
        // Set the dropdown to the saved value
        $('#sortApps').val(savedSort);
        // Apply the sorting
        sortCards(savedSort);
    });

    // Star rating functionality
    $('.star-rating .star-icon').hover(
        function() {
            // Hover in
            const rating = $(this).data('rating');
            const stars = $(this).parent().find('.star-icon');
            stars.removeClass('text-warning').addClass('text-muted');
            stars.slice(0, rating).removeClass('text-muted').addClass('text-warning');
        },
        function() {
            // Hover out - restore original rating
            const container = $(this).parent();
            const appId = container.data('app-id');
            const currentRating = parseInt($(`#current-rating-${appId}`).val(), 10) || 0;
            const stars = container.find('.star-icon');
            stars.removeClass('text-warning').addClass('text-muted');
            stars.slice(0, currentRating).removeClass('text-muted').addClass('text-warning');
        }
    );

    // Handle star click
    $('.star-rating .star-icon').click(function() {
        const rating = $(this).data('rating');
        const container = $(this).parent();
        const appId = container.data('app-id');
        const stars = container.find('.star-icon');

        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Send rating to server
        $.ajax({
            url: `/api/apps/${appId}/`,
            method: 'PATCH',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({ rating: rating }),
            success: function(response) {
                // Update stars
                stars.removeClass('text-warning').addClass('text-muted');
                stars.slice(0, rating).removeClass('text-muted').addClass('text-warning');
                // Store current rating
                if (!$(`#current-rating-${appId}`).length) {
                    container.append(`<input type="hidden" id="current-rating-${appId}" value="${rating}">`);
                } else {
                    $(`#current-rating-${appId}`).val(rating);
                }
            },
            error: function(xhr, status, err) {
                console.error('Failed to update rating:', err);
                // Restore previous rating
                const currentRating = parseInt($(`#current-rating-${appId}`).val(), 10) || 0;
                stars.removeClass('text-warning').addClass('text-muted');
                stars.slice(0, currentRating).removeClass('text-muted').addClass('text-warning');
            }
        });
    });

    // Initialize current ratings
    $('.star-rating').each(function() {
        const container = $(this);
        const appId = container.data('app-id');
        const currentRating = container.find('.text-warning').length;
        container.append(`<input type="hidden" id="current-rating-${appId}" value="${currentRating}">`);
    });

    window.showUserGuide = function(appName, userGuide) {
        document.getElementById('userGuideTitle').textContent = appName;
        document.getElementById('userGuideContent').textContent = userGuide;
        const userGuideModal = new bootstrap.Modal(document.getElementById('userGuideModal'));
        userGuideModal.show();
    };

    window.showLoading = function() {
        document.getElementById('loadingScreen').style.display = 'flex';
    };

    window.hideLoading = function() {
        document.getElementById('loadingScreen').style.display = 'none';
    };

    window.launchApp = function(appId) {
        showLoading();
        const button = document.querySelector(`button[data-app-id="${appId}"]`);
        const statusBadge = document.querySelector(`span.status-badge[data-app-id="${appId}"]`);
        const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        const loadingAppName = document.getElementById('loadingAppName');
        const appName = document.querySelector(`[data-app-id="${appId}"]`).closest('.card').querySelector('.card-title').textContent;
        
        button.disabled = true;
        loadingAppName.textContent = appName;
        loadingModal.show();
        
        // First check if requirements.txt exists
        fetch(`/api/apps/${appId}/check_requirements/`)
            .then(response => response.json())
            .then(data => {
                const installDeps = document.getElementById('installDepsToggle');
                if (!data.exists) {
                    installDeps.checked = false;
                    installDeps.disabled = true;
                    const label = installDeps.nextElementSibling;
                    label.textContent = 'No requirements.txt found';
                } else {
                    installDeps.disabled = false;
                    const label = installDeps.nextElementSibling;
                    label.textContent = 'Install Dependencies';
                }
                
                // Proceed with launch
                return fetch(`/api/apps/${appId}/launch/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ install_dependencies: installDeps.checked && !installDeps.disabled })
                });
            })
            .then(function(response) { 
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json(); 
            })
            .then(function(data) {
                button.textContent = 'Stop';
                button.classList.remove('btn-success');
                button.classList.add('btn-danger');
                button.setAttribute('onclick', `stopApp(${appId})`);
                button.setAttribute('data-action', 'stop');
                statusBadge.textContent = data.port ? `Running (Port: ${data.port})` : 'Running';
                statusBadge.classList.remove('bg-secondary');
                statusBadge.classList.add('bg-success');
                
                // Start polling for output
                pollOutput(appId);
            })
            .catch(function(err) {
                console.error('Error:', err);
                // Only show error if it's not already running
                if (!statusBadge.classList.contains('bg-success')) {
                    alert('Failed to launch application: ' + err.message);
                }
            })
            .finally(function() {
                button.disabled = false;
                hideLoading();
                loadingModal.hide();
            });
    };

    window.stopApp = function(appId) {
        showLoading();
        const button = document.querySelector(`button[data-app-id="${appId}"]`);
        const statusBadge = document.querySelector(`span.status-badge[data-app-id="${appId}"]`);
        
        button.disabled = true;
        
        fetch(`/api/apps/${appId}/stop/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) { 
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json(); 
        })
        .then(function(data) {
            button.textContent = 'Launch';
            button.classList.remove('btn-danger');
            button.classList.add('btn-success');
            button.setAttribute('onclick', `launchApp(${appId})`);
            button.setAttribute('data-action', 'launch');
            statusBadge.textContent = 'Stopped';
            statusBadge.classList.remove('bg-success');
            statusBadge.classList.add('bg-secondary');
        })
        .catch(function(err) {
            console.error('Error:', err);
            alert('Failed to stop application: ' + err.message);
        })
        .finally(function() {
            button.disabled = false;
            hideLoading();
        });
    };

    function pollOutput(appId) {
        const terminalText = document.getElementById('terminalText');
        let serverStarted = false;
        let pollInterval = setInterval(function() {
            fetch(`/api/apps/${appId}/output/`)
                .then(response => response.json())
                .then(data => {
                    if (data.output) {
                        terminalText.textContent = data.output;
                        terminalText.scrollTop = terminalText.scrollHeight;
                        
                        // Check for server start message in the output
                        if (!serverStarted && data.output.includes('Starting development server at')) {
                            const match = data.output.match(/Starting development server at (http:\/\/[^\s]+)/);
                            if (match) {
                                serverStarted = true;
                                const serverUrl = match[1];
                                window.open(serverUrl, '_blank');
                            }
                        }
                    }
                })
                .catch(err => {
                    console.error('Error polling output:', err);
                    clearInterval(pollInterval);
                });
        }, 1000);

        // Store the interval ID to clear it later if needed
        window.outputPollingIntervals = window.outputPollingIntervals || {};
        window.outputPollingIntervals[appId] = pollInterval;
    }

    window.getCookie = function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };

    // Initial status check for all apps
    document.addEventListener('DOMContentLoaded', function() {
        const apps = document.querySelectorAll('[data-app-id]');
        const appIds = new Set();
        apps.forEach(function(element) {
            appIds.add(element.getAttribute('data-app-id'));
        });
        
        appIds.forEach(function(appId) {
            fetch(`/api/apps/${appId}/status/`)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.status === 'Running') {
                        const button = document.querySelector(`button[data-app-id="${appId}"]`);
                        const statusBadge = document.querySelector(`span.status-badge[data-app-id="${appId}"]`);
                        
                        button.textContent = 'Stop';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-danger');
                        button.setAttribute('onclick', `stopApp(${appId})`);
                        statusBadge.textContent = `Running on port ${data.port}`;
                        statusBadge.classList.remove('bg-secondary');
                        statusBadge.classList.add('bg-success');
                    }
                })
                .catch(function(err) {
                    console.error('Error:', err);
                });
        });
    });
})();
</script>
{% endblock %}
